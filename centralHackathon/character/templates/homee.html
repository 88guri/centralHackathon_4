<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
    <script>
        let timer;
        let elapsedTime = {{ character.last_elapsed_time }};
        let timerStarted = false;

        function startTimer() {
            if (!timerStarted) return; // 타이머가 시작된 적이 없으면 return
            if (!timer) {
                timer = setInterval(() => {
                    elapsedTime += 1;
                    document.getElementById("timer").innerText = elapsedTime + " seconds";
                }, 1000);
            }
        }

        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
                sendElapsedTime();
            }
        }

        function pauseTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        function sendElapsedTime() {
            fetch("{% url 'homee' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({elapsed_time: elapsedTime})
            }).then(response => response.json()).then(data => {
                document.getElementById("experience").innerText = "Experience: " + data.experience;
            });
        }

        window.onload = function() {
            document.getElementById("start").addEventListener("click", function() {
                timerStarted = true; // 타이머 시작 플래그 설정
                startTimer();
            });
            document.getElementById("stop").addEventListener("click", function() {
                timerStarted = false; // 타이머 중지 플래그 설정
                stopTimer();
            });
        };

        window.onfocus = function() {
            if (timerStarted) {
                startTimer();
            }
        };

        window.onblur = function() {
            if (timerStarted) {
                pauseTimer();
            }
        };

        function resetAtMidnight() {
            let now = new Date();
            let resetTime = new Date(now);
            resetTime.setHours(1, 3, 0, 0);

            if (now > resetTime) {
                resetTime.setDate(resetTime.getDate() + 1);
            }

            let timeUntilReset = resetTime.getTime() - now.getTime();
            setTimeout(() => {
                sendElapsedTime(); // 경험치 반영 후 타이머 초기화
                elapsedTime = 0;
                document.getElementById("timer").innerText = "0 seconds";
                resetAtMidnight();
            }, timeUntilReset);
        }

        resetAtMidnight();
    </script>
</head>
<body>
    <h1>Welcome, {{ user.username }}!</h1>
    <h2>Character: {{ character.name }}</h2>
    <h3>Level: {{ character.level }}</h3>
    <h3 id="experience">Experience: {{ character.experience }}</h3>
    <h3>Stage: {{ character.stage }}</h3>
    <div id="timer">{{ character.last_elapsed_time }} seconds</div>
    <button id="start">Start Timer</button>
    <button id="stop">Stop Timer</button>
</body>
</html>