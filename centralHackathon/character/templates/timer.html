{% load static %}<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'css/timer.css' %}">
    <title>Timer</title>
    <script>
        let timer;
        let elapsedTime = {{ character.last_elapsed_time }};
        let timerStarted = false; // íƒ€ì´ë¨¸ ì‹œì‘ ì—¬ë¶€
        const maxTime = 10; // progress barì˜ max ê°’ê³¼ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.
        let popup01 = true;
        let exp = {{ character.experience }};
        let rewardEligible = false; // ë³´ìƒ ì—¬ë¶€

        // ì‹œ, ë¶„, ì´ˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatTime(seconds) {
            const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${secs}`;
        }

        // íƒ€ì´ë¨¸ ì‹œì‘ í•¨ìˆ˜
        function startTimer() {
            if (!timerStarted) return; // íƒ€ì´ë¨¸ê°€ ì‹œì‘ëœ ì ì´ ì—†ë‹¤ë©´ return
            if (!timer) {
                timer = setInterval(() => {
                    elapsedTime += 1;
                    document.getElementById("timer").innerText = formatTime(elapsedTime);
                    updateProgressBar(elapsedTime);  // progress ë°” ì—…ë°ì´íŠ¸
                }, 1000);
            }
        }

        // íƒ€ì´ë¨¸ ì •ì§€ í•¨ìˆ˜
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
                sendElapsedTime().then((data) => {
                    exp = data.experience; // ì„œë²„ë¡œë¶€í„° ë°›ì€ ê²½í—˜ì¹˜ë¡œ exp ì—…ë°ì´íŠ¸

                    // popup02 ë‚´ìš© ì—…ë°ì´íŠ¸
                    const popup02 = document.querySelector('.popup02 .popup');
                    popup02.innerHTML = `
                        <h2 class="exp-circle">+${exp}</h2> 
                        <div class="circle-txt">
                            <p>ì´ ${data.hours}ì‹œê°„ ${data.minutes}ë¶„ ${data.seconds}ì´ˆ ì§‘ì¤‘í–ˆê³ </p>
                            <p>+${exp} ê²½í—˜ì¹˜ë¥¼ ì–»ì—ˆì–´ìš”!</p>
                            <p>ì¶•í•˜í•´ìš” ğŸ‰</p>
                        </div>
                        <img class="pop-bak02" src="{% static 'img/circle-bak-for.svg' %}">
                    `;
                    
                    // ì ‘ì† ë³´ìƒ
                    if (data.reward_eligible) {
                        rewardEligible = true;
                        document.getElementById('claimRewardButton').style.display = 'block';
                        document.getElementById('watchAdButton').style.display = 'block';
                    }
                });
            }
        }

        // íƒ€ì´ë¨¸ ì¼ì‹œ ì •ì§€ í•¨ìˆ˜
        function pauseTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // ê²½ê³¼ ì‹œê°„ ì„œë²„ ì „ì†¡ í•¨ìˆ˜
        function sendElapsedTime() {
            return fetch("{% url 'timer_page' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({elapsed_time: elapsedTime})
            }).then(response => response.json()).then(data => {
                console.log(data);
                document.getElementById("experience").innerText = "Experience: " + data.experience;
                document.getElementById("level").innerText = "Level: " + data.level;
                document.getElementById("stage").innerText = "Stage: " + data.stage;
                return data; // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¥¼ ë°˜í™˜
            });
        }

        // progress ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgressBar(time) {
            const progressBar = document.getElementById('time-bar');
            progressBar.value = time % maxTime; // timeì„ maxTimeìœ¼ë¡œ ë‚˜ëˆˆ ë‚˜ë¨¸ì§€ ê°’ì„ valueë¡œ ì„¤ì •
        }

        // ì ‘ì† ë³´ìƒ
        function claimReward() {
            if (rewardEligible) {
                fetch("{% url 'claim_reward' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => response.json()).then(data => {
                    if (data.item) {
                        document.getElementById('rewardMessage').innerHTML = `ë³´ìƒ ì•„ì´í…œ: ${data.item} <img src="${data.image}" style="width: 50px; height: 50px;">`;
                        document.getElementById('claimRewardButton').style.display = 'none';
                        document.getElementById('watchAdButton').style.display = 'none';
                        rewardEligible = false;
                    }
                });
            }
        }

        // ê´‘ê³  ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
        function watchAd() {
            window.location.href = "{% url 'watch_ad' %}";
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.onload = function() {
            document.getElementById("start").addEventListener("click", function() {
                timerStarted = !timerStarted;
                if (timerStarted) {
                    startTimer();
                    document.getElementById("start").innerText = 'S T O P !';
                    if (elapsedTime <= 10 && popup01) {
                        document.getElementsByClassName('popup02')[0].style.display = 'none';
                        stopTimer();
                    }
                } else {
                    stopTimer();
                    document.getElementById("start").innerText = 'S T A R T !';
                    document.getElementsByClassName('popup02')[0].style.display = 'flex';
                }
            });
            document.getElementById("timer").innerText = formatTime(elapsedTime); // ì´ˆê¸° íƒ€ì´ë¨¸ ê°’ì„ ë³€í™˜í•˜ì—¬ í‘œì‹œ
            document.getElementById("claimRewardButton").addEventListener("click", claimReward);
            document.getElementById("watchAdButton").addEventListener("click", watchAd);
        };

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ íƒ€ì´ë¨¸ ì¬ê°œ
        window.onfocus = function() {
            if (timerStarted) {
                startTimer();
            }
        };

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ë²—ì–´ë‚  ì‹œ íƒ€ì´ë¨¸ ì¼ì‹œ ì •ì§€
        window.onblur = function() {
            if (timerStarted) {
                pauseTimer();
            }
        };

        // íƒ€ì´ë¨¸ ìì • ì´ˆê¸°í™” í•¨ìˆ˜
        function resetAtMidnight() {
            let now = new Date();
            let resetTime = new Date(now);
            resetTime.setHours(0, 0, 0, 0);

            if (now > resetTime) {
                resetTime.setDate(resetTime.getDate() + 1);
            }

            let timeUntilReset = resetTime.getTime() - now.getTime();

            setTimeout(() => {
                sendElapsedTime(); // ê²½í—˜ì¹˜ ë°˜ì˜ í›„ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                elapsedTime = 0;
                document.getElementById("timer").innerText = "0 seconds";
                updateProgressBar(elapsedTime); // progress ë°” ì´ˆê¸°í™”
                resetAtMidnight();
            }, timeUntilReset);
        }

        resetAtMidnight();

        // íŒì—… ì‚­ì œ
        function popup01None() {
            const div1 = document.getElementsByClassName('popup01')[0];
            if (popup01) {
                div1.style.display = 'none';
                popup01 = false;
            }
        } 
        function popup02None() {
            const div1 = document.getElementsByClassName('popup02')[0];
            div1.style.display = 'none';
        }  
    </script>
</head>
<body>
    <div class="timer-wrap">
        <button class="bak-button" type="button" onClick="history.go(-1)"><img src={% static 'img/back-btn.svg' %}></button>
        <div class="invisible">
            <h3 id="level">Level: {{ character.level }}</h3>
            <h3 id="experience">Experience: {{ character.experience }}</h3>
            <h3 id="stage">Stage: {{ character.stage }}</h3>
        </div>
        <div class="time-bar">
            <progress id="time-bar" value="0" max="10"></progress>
        </div>
        <p class="time-text">ì§‘ì¤‘ì— ì„±ê³µí•˜ë©´ ê²½í—˜ì¹˜ë¥¼ íšë“í•´ìš”!</p>
        <div class="bubble-wrap">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            
            <p id="timer">{{ character.last_elapsed_time }}:{{ character.last_elapsed_time }}/60:{{ character.last_elapsed_time }} </p>
            <img class="bubble-img" src={% static 'img/circle-bak.svg' %}>  
        </div>

        <div class="container">
            <button id="start">S T A R T !</button>
            <img class="btn" src={% static 'img/btn.svg' %}>
        </div>

        <!-- ì ‘ì† ë³´ìƒ ë°›ê¸° ë²„íŠ¼ ë° ê´‘ê³  ë²„íŠ¼ ì¶”ê°€ -->
        <div class="reward-container">
            <button id="claimRewardButton" style="display: none;">ë³´ìƒ ë°›ê¸°</button>
            <button id="watchAdButton" style="display: none;">ê´‘ê³  ë³´ê¸°</button>
            <p id="rewardMessage"></p>
        </div>
    </div>
    <div class="popup01" onclick='popup01None()'>
        <div class="popup">
            <img class="pop-img" src={% static 'img/main-char.svg' %}>  
            <p>â€œ{{ character.name }}"ì´(ê°€)</p> 
            <p>ë‹¹ì‹ ì˜ ë””ì§€í„¸ ë””í†¡ìŠ¤ë¥¼ ì‘ì›í•´ìš”!ğŸ’ªğŸ»</p>
            <img class="pop-bak" src={% static 'img/circle-bak02.png' %}>
            <img class="pop-bak" src={% static 'img/circle-bak01.png' %}> 
        </div>
    </div>
    <div class="popup02" onclick='popup02None()'>
        <div class="popup">

        </div>
    </div>
</body>
</html>
