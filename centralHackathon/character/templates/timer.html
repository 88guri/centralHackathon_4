<!DOCTYPE html>
<html>
<head>
    <title>Timer</title>
    <script>
        let timer;
        let elapsedTime = {{ character.last_elapsed_time }};
        let timerStarted = false; // 타이머 시작 여부

        // 시간을 시간, 분, 초 단위로 포맷하는 함수
        function formatElapsedTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}시간, ${minutes}분, ${secs}초`;
            } else if (minutes > 0) {
                return `${minutes}분, ${secs}초`;
            } else {
                return `${secs}초`;
            }
        }

        // 타이머 시작 함수
        function startTimer() {
            if (!timerStarted) return; // 타이머가 시작된 적이 없다면 return
            if (!timer) {
                timer = setInterval(() => {
                    elapsedTime += 1;
                    document.getElementById("timer").innerText = formatElapsedTime(elapsedTime);
                }, 1000);
            }
        }

        // 타이머 정지 함수
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
                sendElapsedTime(); // 경과 시간을 서버로 전송
            }
        }

        // 타이머 일시 정지 함수
        function pauseTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // 경과 시간 서버 전송 함수
        function sendElapsedTime() {
            fetch("{% url 'timer_page' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({elapsed_time: elapsedTime})
            }).then(response => response.json()).then(data => {
                document.getElementById("experience").innerText = "Experience: " + data.experience;
                document.getElementById("level").innerText = "Level: " + data.level;
                document.getElementById("stage").innerText = "Stage: " + data.stage;
            });
        }

        // 이벤트 리스너
        window.onload = function() {
            document.getElementById("start").addEventListener("click", function() {
                timerStarted = true; // 타이머 시작 플래그 설정
                startTimer();
            });
            document.getElementById("stop").addEventListener("click", function() {
                timerStarted = false; // 타이머 정지 플래그 설정
                stopTimer();
            });

            document.getElementById("timer").innerText = formatElapsedTime(elapsedTime);
        };

        // 페이지 포커스 시 타이머 재개
        window.onfocus = function() {
            if (timerStarted) {
                startTimer();
            }
        };

        // 페이지 포커스 벗어날 시 타이머 일시 정지
        window.onblur = function() {
            if (timerStarted) {
                pauseTimer();
            }
        };

        // 타이머 자정 초기화 함수
        function resetAtMidnight() {
            let now = new Date();
            let resetTime = new Date(now);
            resetTime.setHours(0, 0, 0, 0);

            if (now > resetTime) {
                resetTime.setDate(resetTime.getDate() + 1);
            }

            let timeUntilReset = resetTime.getTime() - now.getTime();

            setTimeout(() => {
                sendElapsedTime(); // 경험치 반영 후 타이머 초기화
                elapsedTime = 0;
                document.getElementById("timer").innerText = "0 seconds";
                resetAtMidnight();
            }, timeUntilReset);
        }

        resetAtMidnight();
    </script>
</head>
<body>
    <h1>Welcome, {{ user.username }}!</h1>
    <h2>Character: {{ character.name }}</h2>
    <h3 id="level">Level: {{ character.level }}</h3>
    <h3 id="experience">Experience: {{ character.experience }}</h3>
    <h3 id="stage">Stage: {{ character.stage }}</h3>
    <div id="timer">{{ character.last_elapsed_time }} seconds</div>
    <button id="start">Start Timer</button>
    <button id="stop">Stop Timer</button>
</body>
</html>