{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'css/timer.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer</title>
    <script>
        let timer;
        let elapsedTime = {{ character.last_elapsed_time }};
        let timerStarted = false; // íƒ€ì´ë¨¸ ì‹œì‘ ì—¬ë¶€
        const maxTime = 10; // progress barì˜ max ê°’ê³¼ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.
        let exp = {{ character.experience }};
        let rewardEligible = false; // ë³´ìƒ ì—¬ë¶€

        // ì‹œ, ë¶„, ì´ˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatTime(seconds) {
            const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${secs}`;
        }

        // íƒ€ì´ë¨¸ ì‹œì‘ í•¨ìˆ˜
        function startTimer() {
            if (!timerStarted) return; // íƒ€ì´ë¨¸ê°€ ì‹œì‘ëœ ì ì´ ì—†ë‹¤ë©´ return
            if (!timer) {
                timer = setInterval(() => {
                    elapsedTime += 1;
                    document.getElementById("timer").innerText = formatTime(elapsedTime);
                    updateProgressBar(elapsedTime);  // progress ë°” ì—…ë°ì´íŠ¸
                }, 1000);
            }
        }

        // íƒ€ì´ë¨¸ ì •ì§€ í•¨ìˆ˜
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
                sendElapsedTime().then((data) => {
                    exp = data.experience;
                
                    // popup02 ë‚´ìš© ì—…ë°ì´íŠ¸
                    const popup02 = document.querySelector('.popup02 .popup');
                    popup02.innerHTML = `
                        <h2 class="exp-circle">+${exp}</h2> 
                        <div class="circle-txt">
                            <p>ì´ ${data.hours}ì‹œê°„ ${data.minutes}ë¶„ ${data.seconds}ì´ˆ ì§‘ì¤‘í–ˆê³ </p>
                            <p>+${exp} ê²½í—˜ì¹˜ë¥¼ ì–»ì—ˆì–´ìš”!</p>
                            <p>ì¶•í•˜í•´ìš” ğŸ‰</p>
                        </div>
                        <img class="pop-bak02" src="{% static 'img/circle-bak-for.svg' %}">
                    `;
                    
                    // ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥í•  ê²½ìš° reward-container í‘œì‹œ
                    if (data.reward_eligible) {
                        rewardEligible = true;
                        document.querySelector('.reward-container').style.display = 'flex'; // ë³´ìƒ ì»¨í…Œì´ë„ˆ í‘œì‹œ
                    }
                });
            }
        }
        
        // íƒ€ì´ë¨¸ ì¼ì‹œ ì •ì§€ í•¨ìˆ˜
        function pauseTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // ê²½ê³¼ ì‹œê°„ ì„œë²„ ì „ì†¡ í•¨ìˆ˜
        function sendElapsedTime() {
            return fetch("{% url 'timer_page' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({elapsed_time: elapsedTime})
            }).then(response => response.json()).then(data => {
                console.log(data);
                document.getElementById("experience").innerText = "Experience: " + data.experience;
                document.getElementById("level").innerText = "Level: " + data.level;
                document.getElementById("stage").innerText = "Stage: " + data.stage;
                return data; // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¥¼ ë°˜í™˜
            });
        }

        // progress ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgressBar(time) {
            const progressBar = document.getElementById('time-bar');
            progressBar.value = time % maxTime; // timeì„ maxTimeìœ¼ë¡œ ë‚˜ëˆˆ ë‚˜ë¨¸ì§€ ê°’ì„ valueë¡œ ì„¤ì •
        }

        // ì ‘ì† ë³´ìƒ
        function claimReward() {
            if (rewardEligible) {
                fetch("{% url 'claim_reward' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => response.json()).then(data => {
                    if (data.item) {
                        // Update the popup to show the received item
                        document.querySelector('.reward-popup').innerHTML = `
                    <div class="item-display onclick='popup01None()">
                    <button type="submit" class="btn-submit1">
                    <a href="{% url 'timer_page' %}">
                        <img src="{% static 'images/X.png' %}" alt="Close Ad">
                    </a>
                </button>
                        <img src="${data.image}" alt="${data.item}" class="reward-item-image">
                        <p>â€œ{{ character.name }}â€ì˜ ì„ ë¬¼ì„ ë°›ì•˜ì–´ìš”!<br>â€œ${data.item}â€</p>
                    </div>
                    <img src="{% static 'images/giftpopup2.png' %}" alt="Gift Popup Background" class="popup-background">
                ` 
                        document.getElementById('claimRewardButton').style.display = 'none';
                        document.getElementById('watchAdButton').style.display = 'none';
                        rewardEligible = false;
                    }
                });
            }
        }

                // ê´‘ê³  ë³´ê¸° ë²„íŠ¼
                function watchAd() {
                    console.log("watchAd function called");
                    if (rewardEligible) {
                        console.log("rewardEligible is true");
                        fetch("{% url 'watch_ad_reward' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        }).then(response => response.json()).then(data => {
                            console.log("Response from watch_ad_reward:", data);
                            if (data.item_name) {
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = "{% url 'watch_ad2' %}";
                                form.innerHTML = `
                                    <input type="hidden" name="item_name" value="${data.item_name}">
                                    <input type="hidden" name="item_image" value="${data.item_image}">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                `;
                                document.body.appendChild(form);
                                form.submit();
                            } else {
                                console.log("No item_name in response data");
                            }
                        });
                    } else {
                        window.location.href = "{% url 'watch_ad2' %}";
                    }
                }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.onload = function() {
            document.getElementsByClassName("start-stop")[0].addEventListener("click", function() {
                timerStarted = !timerStarted;
                if (timerStarted) {
                    startTimer();
                    document.getElementById("start").innerText = 'S T O P !';
                    document.getElementsByClassName('popup01')[0].style.display = 'flex'; // popup01ë¥¼ í‘œì‹œ
                } else {
                    stopTimer();
                    document.getElementById("start").innerText = 'S T A R T !';
                    document.getElementsByClassName('popup02')[0].style.display = 'flex'; // popup02ë¥¼ í‘œì‹œ
                }
            });
            document.getElementById("timer").innerText = formatTime(elapsedTime); // ì´ˆê¸° íƒ€ì´ë¨¸ ê°’ì„ ë³€í™˜í•˜ì—¬ í‘œì‹œ
            document.getElementById("claimRewardButton").addEventListener("click", claimReward);
            document.getElementById("watchAdButton").addEventListener("click", watchAd);
        };
        
        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ íƒ€ì´ë¨¸ ì¬ê°œ
        window.onfocus = function() {
            if (timerStarted) {
                startTimer();
            }
        };

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ë²—ì–´ë‚  ì‹œ íƒ€ì´ë¨¸ ì¼ì‹œ ì •ì§€
        window.onblur = function() {
            if (timerStarted) {
                pauseTimer();
            }
        };

        // íƒ€ì´ë¨¸ ìì • ì´ˆê¸°í™” í•¨ìˆ˜
        function resetAtMidnight() {
            let now = new Date();
            let resetTime = new Date(now);
            resetTime.setHours(0, 0, 0, 0);

            if (now > resetTime) {
                resetTime.setDate(resetTime.getDate() + 1);
            }

            let timeUntilReset = resetTime.getTime() - now.getTime();

            setTimeout(() => {
                sendElapsedTime(); // ê²½í—˜ì¹˜ ë°˜ì˜ í›„ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                elapsedTime = 0;
                document.getElementById("timer").innerText = "0 seconds";
                updateProgressBar(elapsedTime); // progress ë°” ì´ˆê¸°í™”
                resetAtMidnight();
            }, timeUntilReset);
        }

        resetAtMidnight();

        // íŒì—… ì‚­ì œ
        function popup01None() {
            const div1 = document.getElementsByClassName('popup01')[0];
            div1.style.display = 'none';
        } 
        function popup02None() {
            const div1 = document.getElementsByClassName('popup02')[0];
            div1.style.display = 'none';
        }  
    </script>
</head>
<body>
    <div class="timer-wrap">
        <button class="bak-button" type="button" onClick="history.go(-1)">
            <img src={% static 'img/back-btn.svg' %}>
        </button>
        <div class="invisible">
            <h3 id="level">Level: {{ character.level }}</h3>
            <h3 id="experience">Experience: {{ character.experience }}</h3>
            <h3 id="stage">Stage: {{ character.stage }}</h3>
        </div>
        <div class="time-bar">
            <progress id="time-bar" value="0" max="10"></progress>
        </div>
        <p class="time-text">ì§‘ì¤‘ì— ì„±ê³µí•˜ë©´ ê²½í—˜ì¹˜ë¥¼ íšë“í•´ìš”!</p>
        <div class="bubble-wrap">
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>
            <div class="bubble"></div>
            <div class="tity"></div>

            <p id="timer">{{ character.last_elapsed_time }}:{{ character.last_elapsed_time }}/60:{{ character.last_elapsed_time }} </p>
            <img class="bubble-img" src={% static 'img/circle-bak.svg' %}>
        </div>

        <div class="container">
            <button id="start" class="start-stop">S T A R T !</button>
            <img class="btn" src={% static 'img/btn.svg' %}>
        </div>

        <div class="reward-container" style="display: none;">
            <div class="reward-popup">
                <img src="{% static 'images/giftpopup.png' %}" alt="Gift Popup Background" class="popup-background">
                <p>4ì‹œê°„ ì´ìƒ ì§‘ì¤‘í•´ì„œ<br>â€œ{{ character.name }}â€ì˜ ì„ ë¬¼ì´ ë„ì°©í–ˆì–´ìš”!</p>
                <div class="reward-buttons">
                    <button id="claimRewardButton">
                        <img src="{% static 'images/gift.png' %}" alt="Gift Icon"> ì„ ë¬¼ ë°›ê¸°
                    </button>
                    <button id="watchAdButton">
                        <img src="{% static 'images/play.png' %}" alt="Play Icon"> ì„ ë¬¼ 2ë°°ë¡œ ë°›ê¸°
                    </button>
                    <p id="rewardMessage"></p>
                </div>
            </div>
        </div>

        <div class="popup01" onclick='popup01None()'>
            <div class="popup">
                <img class="pop-img" src={% static 'img/main-char.svg' %}>
                <p>â€œ{{ character.name }}"ì´(ê°€)</p>
                <p>ë‹¹ì‹ ì˜ ë””ì§€í„¸ ë””í†¡ìŠ¤ë¥¼ ì‘ì›í•´ìš”!ğŸ’ªğŸ»</p>
                <img class="pop-bak" src={% static 'img/circle-bak02.png' %}>
                <img class="pop-bak" src={% static 'img/circle-bak01.png' %}>
            </div>
        </div>
        <div class="popup02" onclick='popup02None()'>
            <div class="popup">
            </div>
        </div>
    </div>
    <script>
             document.addEventListener('DOMContentLoaded', function() {
    // ë ˆë²¨ ê°’ì„ ê°€ì ¸ì˜´ 
    var characterLevel = {{ character.level|default:1 }};

    // í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ì´ë¯¸ì§€ ìš”ì†Œ ì„ íƒ
    var imageElement = document.querySelector('.popup01 .pop-img');
    
    // ë ˆë²¨ì— ë”°ë¼ ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„¤ì •
    if (characterLevel >= 30) {
        imageElement.src = "{% static 'images/adult.png' %}";
    } else if (characterLevel >= 5) {
        imageElement.src = "{% static 'images/child.png' %}";
    } else {
        imageElement.src = "{% static 'images/default.png' %}";
    }
});

    </script>
</body>
</html>
