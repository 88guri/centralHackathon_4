<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>홈페이지</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}?v=1.0">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="level-info">
                <span class="character-name">{{ character.name }}</span>
                <div class="level-bar-container">
                    <span class="level-text">LV.<span id="character-level">{{ character.level }}</span></span>
                    <div class="progress-bar">
                        <div class="progress" id="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="character-container">
            <!-- Add the character image here -->
            <img id="character-image" src="{% static 'images/default.png' %}" alt="Character" class="character">
        </div>
        <div class="footer">
            <div class="button" onclick="window.location.href='{% url 'history_page' %}'">
                <img src="{% static 'images/history.png' %}" alt="History Icon" class="icon history">
                <span>히스토리</span>
            </div>
            <div class="button" onclick="window.location.href='{% url 'timer_page' %}'">
                <img src="{% static 'images/timer.png' %}" alt="Timer Icon" class="icon timer">
                <span>타이머</span>
            </div>
            <div class="button" onclick="window.location.href='{% url 'deco' %}'">
                <img src="{% static 'images/dress.png' %}" alt="Dressroom Icon" class="icon dressroom">
                <span>드레스룸</span>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function updateCharacter() {
                var level = parseInt(document.getElementById('character-level').innerText, 10);
                var currentExperience = {{ current_experience }};
                var maxExperience = {{ max_experience }};
                var progressBar = document.getElementById('progress-bar');
                var characterImage = document.getElementById('character-image');
                var charDiv = document.querySelector('.character-container');

                // 진행 상황 바의 너비를 레벨에 따라 조정
                var progressWidth = (currentExperience / maxExperience) * 100;
                progressBar.style.width = progressWidth + '%';

                // 캐릭터 진화 설정
                var imageSrc;
                if (level >= 30) {
                    imageSrc = "{% static 'images/adult.png' %}";
                } else if (level >= 5) {
                    imageSrc = "{% static 'images/child.png' %}";
                } else {
                    imageSrc = "{% static 'images/default.png' %}";
                }
                characterImage.src = imageSrc;

                // Set the class name based on the image source
                var className = imageSrc.split('/').pop().split('.')[0];
                characterImage.className = className;

                // 로컬 저장소에서 캐릭터 아이템을 로드합니다
                var charItems = JSON.parse(localStorage.getItem('charItems')) || {};

                // 현재 캐릭터 컨테이너의 기존 아이템을 지웁니다
                charDiv.querySelectorAll('img:not(#character-image)').forEach(function(img) {
                    img.remove();
                });

                // 로컬 저장소에서 아이템을 적용합니다
                for (var type in charItems) {
                    if (charItems.hasOwnProperty(type)) {
                        var img = document.createElement('img');
                        img.src = charItems[type];
                        img.className = `char-${type}`;
                        charDiv.appendChild(img);
                    }
                }
            }

            updateCharacter(); // 처음 로드 시 데이터 업데이트

            // 데이터가 변경되었을 때 로컬 저장소에서 강제로 업데이트
            window.addEventListener('storage', function(event) {
                if (event.key === 'charItems') {
                    updateCharacter();
                }
            });
        });
    </script>
</body>
</html>
